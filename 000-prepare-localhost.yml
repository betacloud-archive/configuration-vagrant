# This file is subject to the terms and conditions defined in file 'LICENSE',
# which is part of this repository.
#
# DO NOT EDIT THIS FILE BY HAND -- FILE IS SYNCHRONIZED REGULARLY
---
- name: Create required directories
  hosts: localhost
  connection: local

  tasks:
  - name: Include secrets
    include_vars: secrets.yml

  - name: Create required directories
    file:
      path: "{{ item }}"
      state: directory
      owner: "{{ operator_user }}"
      group: "{{ operator_user }}"
      mode: 0700
    with_items:
      - "{{ ansible_roles_path }}"
      - /opt/ansible-cache
      - /opt/ansible-logs
      - /opt/ansible-secrets
    become: true

  # NOTE: This keyfile has to be written to be usable by Ansible itself.
  - name: Create ssh private key file
    copy:
      content: "{{ kolla_private_key }}"
      dest: /opt/ansible-secrets/id_rsa.kolla
      mode: 0600

- name: Download and install private ansible roles
  hosts: localhost
  connection: local

  tasks:
  - name: Include secrets
    include_vars: secrets.yml

  - name: Download private tarballs
    get_url:
      url: "https://{{ nexus_server }}/repository/{{ nexus_roles_repository }}/{{ item }}-{{ nexus_roles_version }}.tar.gz"
      dest: "{{ ansible_roles_path }}/{{ item }}.tar.gz"
      mode: 0644
      url_username: "{{ nexus_username }}"
      url_password: "{{ nexus_password }}"
      force_basic_auth: yes
      backup: yes
    with_items: "{{ ansible_roles_private }}"

  - name: Install required ansible roles
    command: ansible-galaxy install -f -r roles/roles-seed.yml

  - name: Remove private tarballs
    file:
      path: "{{ ansible_roles_path }}/{{ item }}.tar.gz"
      state: absent
    with_items: "{{ ansible_roles_private }}"
